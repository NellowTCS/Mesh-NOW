name: Hardware Testing & Integration

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'basic'
        type: choice
        options:
          - 'basic'
          - 'stress'
          - 'compatibility'
          - 'performance'

jobs:
  # Firmware validation tests
  firmware-validation:
    name: Firmware Validation Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [esp32, esp32s2, esp32s3, esp32c3, esp32c6]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: 'v5.5.1'

      - name: Build firmware for ${{ matrix.target }}
        run: |
          idf.py set-target ${{ matrix.target }}
          cp configs/sdkconfig.${{ matrix.target }} sdkconfig.defaults
          idf.py build

      - name: Validate binary structure
        run: |
          echo "Validating ${{ matrix.target }} binary..."
          
          # Check if binary exists and has reasonable size
          if [ ! -f "build/mesh-now.bin" ]; then
            echo "ERROR: Binary not found"
            exit 1
          fi
          
          BINARY_SIZE=$(stat -c%s build/mesh-now.bin)
          MIN_SIZE=500000  # 500KB minimum
          MAX_SIZE=2000000 # 2MB maximum
          
          if [ $BINARY_SIZE -lt $MIN_SIZE ]; then
            echo "ERROR: Binary too small ($BINARY_SIZE bytes)"
            exit 1
          fi
          
          if [ $BINARY_SIZE -gt $MAX_SIZE ]; then
            echo "ERROR: Binary too large ($BINARY_SIZE bytes)"
            exit 1
          fi
          
          echo "Binary size OK: $BINARY_SIZE bytes"

      - name: Check memory usage
        run: |
          echo "Memory analysis for ${{ matrix.target }}:"
          idf.py size-components | head -20

      - name: Extract and validate configuration
        run: |
          echo "Configuration check for ${{ matrix.target }}:"
          
          # Check key configuration options
          if grep -q "CONFIG_ESP_WIFI_ENABLED=y" sdkconfig; then
            echo "WiFi enabled"
          else
            echo "WiFi not enabled"
            exit 1
          fi
          
          if grep -q "CONFIG_HTTPD_MAX_REQ_HDR_LEN" sdkconfig; then
            echo "HTTP server configured"
          else
            echo "HTTP server not configured"
            exit 1
          fi

  # Network stack testing
  network-tests:
    name: Network Stack Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: 'v5.5.1'

      - name: Build with network debugging
        run: |
          idf.py set-target esp32
          cp configs/sdkconfig.esp32 sdkconfig.defaults
          
          # Enable additional logging for testing
          echo "CONFIG_LOG_DEFAULT_LEVEL_DEBUG=y" >> sdkconfig.defaults
          echo "CONFIG_LOG_MAXIMUM_LEVEL=5" >> sdkconfig.defaults
          
          idf.py build

      - name: Analyze network components
        run: |
          echo "Network component analysis:"
          idf.py size-components | grep -E "(lwip|wifi|esp_netif|esp_http|esp_now)"

  # Compatibility testing
  compatibility-tests:
    name: ESP-IDF Compatibility Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        idf_version: ['v5.4.0', 'v5.5.1']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ESP-IDF ${{ matrix.idf_version }}
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: ${{ matrix.idf_version }}

      - name: Test build compatibility
        run: |
          echo "Testing compatibility with ESP-IDF ${{ matrix.idf_version }}"
          
          # Test ESP32 build (most compatible)
          idf.py set-target esp32
          cp configs/sdkconfig.esp32 sdkconfig.defaults
          
          # Try to build
          if idf.py build; then
            echo "Compatible with ESP-IDF ${{ matrix.idf_version }}"
          else
            echo "Not compatible with ESP-IDF ${{ matrix.idf_version }}"
            exit 1
          fi

      - name: Compare binary sizes
        run: |
          BINARY_SIZE=$(stat -c%s build/mesh-now.bin)
          echo "Binary size with ESP-IDF ${{ matrix.idf_version }}: $BINARY_SIZE bytes"

  # Performance benchmarking
  performance-tests:
    name: Performance Benchmarking
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'performance' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: 'v5.5.1'

      - name: Build optimized firmware
        run: |
          idf.py set-target esp32
          cp configs/sdkconfig.esp32 sdkconfig.defaults
          
          # Enable performance optimizations
          echo "CONFIG_COMPILER_OPTIMIZATION_PERF=y" >> sdkconfig.defaults
          echo "CONFIG_COMPILER_OPTIMIZATION_ASSERTIONS_DISABLE=y" >> sdkconfig.defaults
          
          idf.py build

      - name: Analyze performance characteristics
        run: |
          echo "Performance analysis:"
          echo "Binary size: $(stat -c%s build/mesh-now.bin) bytes"
          
          echo "Memory usage:"
          idf.py size | grep -E "(Used|Available)"
          
          echo "Component sizes:"
          idf.py size-components | head -10

      - name: Generate performance report
        run: |
          cat > performance_report.md << EOF
          # Mesh-NOW Performance Report
          
          **Build Date:** $(date -u)
          **Commit:** ${{ github.sha }}
          **ESP-IDF Version:** v5.5.1
          
          ## Binary Size Analysis
          \`\`\`
          $(idf.py size)
          \`\`\`
          
          ## Top Components by Size
          \`\`\`
          $(idf.py size-components | head -10)
          \`\`\`
          
          ## Memory Layout
          - Flash usage optimized for ESP32 (4MB)
          - RAM usage efficient for real-time mesh operations
          - Component separation for modularity
          EOF

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.sha }}
          path: performance_report.md

  # Integration test summary
  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [firmware-validation, network-tests, compatibility-tests]
    if: always()
    
    steps:
      - name: Collect test results
        run: |
          echo "Integration Test Summary"
          echo "======================="
          echo "Firmware Validation: ${{ needs.firmware-validation.result }}"
          echo "Network Tests: ${{ needs.network-tests.result }}"
          echo "Compatibility Tests: ${{ needs.compatibility-tests.result }}"
          
          # Create test report
          cat > integration_report.md << EOF
          # Mesh-NOW Integration Test Report
          
          **Test Date:** $(date -u)
          **Commit:** ${{ github.sha }}
          
          ## Test Results
          
          | Test Suite | Status |
          |------------|--------|
          | Firmware Validation | ${{ needs.firmware-validation.result }} |
          | Network Tests | ${{ needs.network-tests.result }} |
          | Compatibility Tests | ${{ needs.compatibility-tests.result }} |
          
          ## Target Coverage
          
          All ESP32 variants tested:
          - ESP32 (Xtensa dual-core)
          - ESP32-S2 (Xtensa single-core)
          - ESP32-S3 (Xtensa dual-core + PSRAM)
          - ESP32-C3 (RISC-V single-core)
          - ESP32-C6 (RISC-V single-core + 802.15.4)
          
          ## Recommendations
          
          - All targets build successfully
          - Memory usage within acceptable limits
          - ESP-IDF compatibility verified
          EOF

      - name: Upload integration report
        uses: actions/upload-artifact@v4
        with:
          name: integration-report-${{ github.sha }}
          path: integration_report.md